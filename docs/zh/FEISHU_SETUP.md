# 飞书通道对接操作手册

> [English](FEISHU_SETUP.md)

本文档说明如何将 QueryClaw 接入飞书，使 Agent 能在飞书中接收用户提问并回复。

---

## 前置条件

- 飞书企业账号（需有应用开发权限）
- 本地或服务器能访问飞书 API
- QueryClaw 已配置数据库和 LLM（参见 [USER_MANUAL.md](USER_MANUAL.md)）

---

## 一、安装依赖

```bash
pip install queryclaw[feishu]
```

---

## 二、在飞书开放平台创建应用

飞书通道使用 **WebSocket 长连接**，无需公网 IP 或域名，只需本地能访问飞书 API。

1. **创建应用**：在 [飞书开放平台](https://open.feishu.cn/app) 创建企业自建应用。
2. **获取凭证**：在「凭证与基础信息」中获取 `App ID` 和 `App Secret`。
3. **启用机器人**：在「功能」→「机器人」中启用机器人能力。
4. **配置权限**：在「权限管理」中增加：
   - `im:message` 相关：接收消息、发送消息、群组内发送消息。
   - `im:message.p2p_chat`：接收与发送私聊消息（私聊必需）。
   - `im:message.group_at_msg`：接收群聊中 @ 机器人的消息。
5. **事件订阅**：在「事件与回调」中，选择 **「使用长连接接收事件」** 并保存。若页面有「添加事件」选项，勾选 **「接收消息」**（或「接收消息 v2.0」）后保存。
   - **重要**：需先运行 `queryclaw serve` 建立连接后，再在后台保存，否则保存可能失败。
6. **发布应用**：在「版本管理与发布」中创建版本并发布。
7. **添加机器人**：
   - **群聊**：打开群聊 → 右上角「⋯」→「群机器人」→「添加机器人」→ 搜索你的应用名称并添加。添加后，在群里 @ 机器人即可提问。
   - **私聊**：在飞书客户端顶部搜索框输入应用名称，选择该应用并发起对话。

---

## 三、配置 QueryClaw

在 `config.json` 的 `channels.feishu` 中填入：

```json
"feishu": {
  "enabled": true,
  "app_id": "cli_xxx",
  "app_secret": "your_secret",
  "allow_from": []
}
```

---

## 四、启动服务

```bash
queryclaw serve
```

---

## 五、常见问题

### 私聊能搜到应用但无法对话？

| 原因 | 排查与处理 |
|------|------------|
| **应用可用范围** | 发布版本时「可用范围」需包含当前用户。在开放平台「版本管理与发布」→ 创建新版本 → 将可用范围设为「全部成员」或加入你的组织/用户组，重新发布。 |
| **事件订阅未生效** | 「事件与回调」必须选择「使用长连接接收事件」并保存成功。需先运行 `queryclaw serve` 建立连接，再在后台保存。保存失败时，检查 serve 是否在运行、网络是否可达飞书。 |
| **serve 未运行** | 确保 `queryclaw serve` 持续运行；退出后机器人无法收消息、无法回复。 |
| **权限未开通** | 在「权限管理」中确认 `im:message`、`im:message.p2p_chat` 等已申请且状态为「已开通」。新加权限后需重新发布版本。 |

### serve 端收不到消息？

若发消息后终端无 `[Feishu] Received event` 日志，说明事件未到达 handler，可按以下步骤排查：

1. **确认 WebSocket 已连接**：启动 `queryclaw serve` 后，终端应出现 `connected to wss://...`（来自 lark-oapi）。若没有，检查 `app_id`、`app_secret` 是否正确、网络是否可达飞书。
2. **在连接在线时保存事件订阅**：必须在 `queryclaw serve` 已启动且连接成功后，再去开放平台「事件与回调」→ 选择「使用长连接接收事件」→ 若有「添加事件」，勾选「接收消息」→ 保存。若在连接建立前保存，可能无法收到消息。
